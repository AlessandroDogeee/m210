name: Build & Deploy to OpenShift

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Login to GHCR
      run: |
        echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

    - name: Build container
      run: |
        docker build -t ghcr.io/${{ secrets.GHCR_USERNAME }}/html-openshift-app:latest .

    - name: Push container
      run: |
        docker push ghcr.io/${{ secrets.GHCR_USERNAME }}/html-openshift-app:latest

    - name: Install OC CLI
      run: |
        curl -s https://downloads-openshift-console.apps.exoscale-ch-gva-2-0.appuio.cloud/amd64/linux/oc.tar \
        | tar xvf - --exclude="*.md" -C /usr/local/bin/

    - name: OpenShift Login
      run: |
        oc login "${{ secrets.OPENSHIFT_SERVER }}" --token="${{ secrets.OPENSHIFT_TOKEN }}"

    - name: Select Namespace
      run: |
        oc project "${{ secrets.OPENSHIFT_NAMESPACE }}"

    - name: Patch Deployment Image
      run: |
        oc set image deployment/html-openshift-app \
        html-openshift-app=ghcr.io/${{ secrets.GHCR_USERNAME }}/html-openshift-app:latest

    - name: Apply Deployment (fallback if not exists)
      run: |
        oc apply -f deployment.yaml || echo "Deployment already exists â€“ skipped"

    - name: Rollout Restart
      run: |
        oc rollout restart deployment/html-openshift-app
